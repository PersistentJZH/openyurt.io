"use strict";(self.webpackChunkopenyurt_io=self.webpackChunkopenyurt_io||[]).push([[3117],{3905:function(e,t,n){n.d(t,{Zo:function(){return d},kt:function(){return m}});var o=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function u(e,t){if(null==e)return{};var n,o,r=function(e,t){if(null==e)return{};var n,o,r={},a=Object.keys(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)n=a[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var i=o.createContext({}),s=function(e){var t=o.useContext(i),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},d=function(e){var t=s(e.components);return o.createElement(i.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},c=o.forwardRef((function(e,t){var n=e.components,r=e.mdxType,a=e.originalType,i=e.parentName,d=u(e,["components","mdxType","originalType","parentName"]),c=s(n),m=r,k=c["".concat(i,".").concat(m)]||c[m]||p[m]||a;return n?o.createElement(k,l(l({ref:t},d),{},{components:n})):o.createElement(k,l({ref:t},d))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=n.length,l=new Array(a);l[0]=c;var u={};for(var i in t)hasOwnProperty.call(t,i)&&(u[i]=t[i]);u.originalType=e,u.mdxType="string"==typeof e?e:r,l[1]=u;for(var s=2;s<a;s++)l[s]=n[s];return o.createElement.apply(null,l)}return o.createElement.apply(null,n)}c.displayName="MDXCreateElement"},6137:function(e,t,n){n.r(t),n.d(t,{assets:function(){return i},contentTitle:function(){return l},default:function(){return p},frontMatter:function(){return a},metadata:function(){return u},toc:function(){return s}});var o=n(7462),r=(n(7294),n(3905));const a={title:"Join Nodes"},l=void 0,u={unversionedId:"installation/yurtadm-join",id:"installation/yurtadm-join",title:"Join Nodes",description:"There are two ways to join nodes into OpenYurt cluster in terms of the node status.",source:"@site/docs/installation/yurtadm-join.md",sourceDirName:"installation",slug:"/installation/yurtadm-join",permalink:"/docs/next/installation/yurtadm-join",draft:!1,editUrl:"https://github.com/openyurtio/openyurt.io/edit/master/docs/installation/yurtadm-join.md",tags:[],version:"current",lastUpdatedBy:"windydayc",lastUpdatedAt:1662815781,formattedLastUpdatedAt:"Sep 10, 2022",frontMatter:{title:"Join Nodes"},sidebar:"docs",previous:{title:"How to use `kubeconfig` to experience OpenYurt capabilities",permalink:"/docs/next/installation/openyurt-experience-center/kubeconfig"},next:{title:"Architecture",permalink:"/docs/next/core-concepts/architecture"}},i={},s=[{value:"1. Joining nodes from scratch",id:"1-joining-nodes-from-scratch",level:2},{value:"1.1 yurtadm join",id:"11-yurtadm-join",level:3},{value:"1.2 yurtadm reset",id:"12-yurtadm-reset",level:3},{value:"1.3 FAQ",id:"13-faq",level:3},{value:"2. Install OpenYurt node components",id:"2-install-openyurt-node-components",level:2},{value:"2.1 Label your node",id:"21-label-your-node",level:3},{value:"2.2 Setup Yurthub",id:"22-setup-yurthub",level:3},{value:"2.3 Configure Kubelet",id:"23-configure-kubelet",level:3},{value:"2.4 Restart Pods",id:"24-restart-pods",level:3}],d={toc:s};function p(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,o.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"There are two ways to join nodes into OpenYurt cluster in terms of the node status."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/docs/next/installation/yurtadm-join#1-joining-nodes-from-scratch"},"Join a node into OpenYurt cluster from scratch")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/docs/next/installation/yurtadm-join#2-install-openyurt-node-components"},"Install OpenYurt node components"))),(0,r.kt)("h2",{id:"1-joining-nodes-from-scratch"},"1. Joining nodes from scratch"),(0,r.kt)("h3",{id:"11-yurtadm-join"},"1.1 yurtadm join"),(0,r.kt)("p",null,"Users can join cloud nodes and edge nodes to the OpenYurt cluster using Yurtadm join. Note that when joining a node, the runtime needs to be installed on the node and the swap partition is turned off."),(0,r.kt)("p",null,"Execute the following command to join the edge node to cluster:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"$ _output/local/bin/linux/amd64/yurtadm join 1.2.3.4:6443 --token=zffaj3.a5vjzf09qn9ft3gt --node-type=edge --discovery-token-unsafe-skip-ca-verification --v=5\n")),(0,r.kt)("p",null,"Execute the following command to join the cloud node to cluster:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"$ _output/local/bin/linux/amd64/yurtadm join 1.2.3.4:6443 --token=zffaj3.a5vjzf09qn9ft3gt --node-type=cloud --discovery-token-unsafe-skip-ca-verification --v=5\n")),(0,r.kt)("p",null,"When the runtime of the edge node is containerd, the ",(0,r.kt)("inlineCode",{parentName:"p"},"cri-socket")," parameter needs to be configured. For example, change the command above of joining the edge node to:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"$ _output/local/bin/linux/amd64/yurtadm join 1.2.3.4:6443 --token=zffaj3.a5vjzf09qn9ft3gt --node-type=edge --discovery-token-unsafe-skip-ca-verification --cri-socket=/run/containerd/containerd.sock --v=5\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"how to compile ",(0,r.kt)("inlineCode",{parentName:"li"},"yurtadm")," binary, please refer to the link ",(0,r.kt)("a",{parentName:"li",href:"/docs/next/installation/yurtadm-init#21-compile-yurtadm"},"here"))),(0,r.kt)("p",null,"Explanation of parameters:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"1.2.3.4:6443"),":  The address of apiserver"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"--token"),"\uff1abootstrap token"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"--node-type"),"\uff1aopenyurt node type\uff0ccan be cloud or edge")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"The process of "),"yurtadm join` will automatically install the following k8s components:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"kubeadm"),(0,r.kt)("li",{parentName:"ul"},"kubectl"),(0,r.kt)("li",{parentName:"ul"},"kubelet"),(0,r.kt)("li",{parentName:"ul"},"kube-proxy")),(0,r.kt)("h3",{id:"12-yurtadm-reset"},"1.2 yurtadm reset"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"yurtadm reset")," can be used when it is necessary to delete a node that was joined using ",(0,r.kt)("inlineCode",{parentName:"p"},"yurtadm join"),". Here are the detailed steps:"),(0,r.kt)("p",null,"In master\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"kubectl drain {NodeName} --delete-local-data --force --ignore-daemonsets\nkubectl delete node {NodeName}\n")),(0,r.kt)("p",null,"In joined node:"),(0,r.kt)("p",null,"1","."," execute ",(0,r.kt)("inlineCode",{parentName:"p"},"yurtadm reset")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"yurtadm reset\n")),(0,r.kt)("p",null,"2","."," delete ",(0,r.kt)("inlineCode",{parentName:"p"},"/etc/cni/net.d")," dir\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"rm -rf /etc/cni/net.d\n")),(0,r.kt)("h3",{id:"13-faq"},"1.3 FAQ"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"1. yurtadm join error\uff1acrictl not found in system path")),(0,r.kt)("p",null,"The node does not have docker installed, and installing docker can solve this problem."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"2. yurtadm join error\uff1a","[ERROR FileExisting-conntrack]",": conntrack not found in system path")),(0,r.kt)("p",null,"Execute ",(0,r.kt)("inlineCode",{parentName:"p"},"yum install -y conntrack")," and then execute the yurtadm join command again."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"3. kubectl logs edge node error\uff1aerror: Error from server (ServiceUnavailable): the server is currently unable to handle the request ( pods/log xxx)")," "),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/openyurtio/openyurt/issues/984"},"https://github.com/openyurtio/openyurt/issues/984")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"4. kubectl logs edge node error\uff1aerror: You must be logged in to the server (the server has asked for the client to provide credentials ( pods/log xxx))")," "),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/openyurtio/openyurt/issues/984"},"https://github.com/openyurtio/openyurt/issues/984")),(0,r.kt)("h2",{id:"2-install-openyurt-node-components"},"2. Install OpenYurt node components"),(0,r.kt)("p",null,"You should only install node components of OpenYurt on nodes that already have been joined in the Kubernetes cluster."),(0,r.kt)("h3",{id:"21-label-your-node"},"2.1 Label your node"),(0,r.kt)("p",null,"OpenYurt distinguish cloud nodes and edge nodes through the node label ",(0,r.kt)("inlineCode",{parentName:"p"},"openyurt.io/is-edge-worker"),". From this, it makes the decision that whether to evict Pods on this node. Assume we have a node named ",(0,r.kt)("inlineCode",{parentName:"p"},"us-west-1.192.168.0.88")," which is an edge node."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ kubectl label node us-west-1.192.168.0.88 openyurt.io/is-edge-worker=true\nnode/us-west-1.192.168.0.88 labeled\n")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"If ",(0,r.kt)("inlineCode",{parentName:"p"},"us-west-1.192.168.0.88")," is a cloud node, then you should change the label from ",(0,r.kt)("inlineCode",{parentName:"p"},"true")," to ",(0,r.kt)("inlineCode",{parentName:"p"},"false"))),(0,r.kt)("p",null,"To further activate the node autonomous mode, we add an annotation to this edge node:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ kubectl annotate node us-west-1.192.168.0.88 node.beta.openyurt.io/autonomy=true\nnode/us-west-1.192.168.0.88 annotated\n")),(0,r.kt)("p",null,"Also if you want to take advantage of the unitization ability of OpenYurt, you can add this node to an nodePool."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ cat <<EOF | kubectl apply -f -\napiVersion: apps.openyurt.io/v1alpha1\nkind: NodePool\nmetadata:\n  name: worker\nspec:\n  type: Edge\nEOF\n$ kubectl label node us-west-1.192.168.0.87 apps.openyurt.io/desired-nodepool=worker\n")),(0,r.kt)("h3",{id:"22-setup-yurthub"},"2.2 Setup Yurthub"),(0,r.kt)("p",null,"Before proceeding, we need to prepare the following items:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Get the apiserver's address (i.e., ip:port) and a ",(0,r.kt)("a",{parentName:"li",href:"https://kubernetes.io/docs/reference/access-authn-authz/bootstrap-tokens/"},"bootstrap token"),", which will be used to replace the placeholder in the template file ",(0,r.kt)("inlineCode",{parentName:"li"},"config/setup/yurthub.yaml"),".")),(0,r.kt)("p",null,"In the following command, we assume that the address of the apiserver is 1.2.3.4:5678 and bootstrap token is 07401b.f395accd246ae52d"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ cat config/setup/yurthub.yaml |\nsed 's|__kubernetes_master_address__|1.2.3.4:5678|;\ns|__bootstrap_token__|07401b.f395accd246ae52d|' > /tmp/yurthub-ack.yaml &&\nscp -i <yourt-ssh-identity-file> /tmp/yurthub-ack.yaml root@us-west-1.192.168.0.88:/etc/kubernetes/manifests\n")),(0,r.kt)("p",null,"and the Yurthub will be ready in minutes."),(0,r.kt)("h3",{id:"23-configure-kubelet"},"2.3 Configure Kubelet"),(0,r.kt)("p",null,"we need to reset the kubelet service to let it access the apiserver through the yurthub (The following steps assume that we have logged on to the edge node as the root user).\nAs kubelet will connect to the Yurthub through HTTP, so we create a new kubeconfig file for the kubelet service."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir -p /var/lib/openyurt\ncat << EOF > /var/lib/openyurt/kubelet.conf\napiVersion: v1\nclusters:\n- cluster:\n    server: http://127.0.0.1:10261\n  name: default-cluster\ncontexts:\n- context:\n    cluster: default-cluster\n    namespace: default\n    user: default-auth\n  name: default-context\ncurrent-context: default-context\nkind: Config\npreferences: {}\nEOF\n")),(0,r.kt)("p",null,"In order for let kubelet to use the new kubeconfig, we edit the drop-in file of the kubelet service (i.e., ",(0,r.kt)("inlineCode",{parentName:"p"},"/etc/systemd/system/kubelet.service.d/10-kubeadm.conf")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"/usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf")," for CentOS)"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'sed -i "s|KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=\\/etc\\/kubernetes\\/bootstrap-kubelet.conf\\ --kubeconfig=\\/etc\\/kubernetes\\/kubelet.conf|KUBELET_KUBECONFIG_ARGS=--kubeconfig=\\/var\\/lib\\/openyurt\\/kubelet.conf|g" \\\n    /etc/systemd/system/kubelet.service.d/10-kubeadm.conf\n')),(0,r.kt)("p",null,"then, we restart the kubelet service"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# assume we are logged in to the edge node already\n$ systemctl daemon-reload && systemctl restart kubelet\n")),(0,r.kt)("p",null,"Finally, we need to make sure node is ready after kubelet restart."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ kubectl get nodes\nNAME                     STATUS   ROLES    AGE     VERSION\nus-west-1.192.168.0.87   Ready    <none>   3d23h   v1.20.11\nus-west-1.192.168.0.88   Ready    <none>   3d23h   v1.20.11\n")),(0,r.kt)("h3",{id:"24-restart-pods"},"2.4 Restart Pods"),(0,r.kt)("p",null,"After Yurthub installation and kubelet restart, all pods on this edge node should be recreated in order to make sure pods access kube-apiserver through Yurthub.\nBefore performing this operation, confirm the impact on the production environment."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ kubectl get pod -A -o wide | grep us-west-1.192.168.0.88\nkube-system   yurt-hub-us-west-1.192.168.0.88           1/1     Running   0          19d     172.16.0.32    us-west-1.192.168.0.88   <none>           <none>\nkube-system   coredns-qq6dk                             1/1     Running   0          19d     10.148.2.197   us-west-1.192.168.0.88   <none>           <none>\nkube-system   kube-flannel-ds-j698r                     1/1     Running   0          19d     172.16.0.32    us-west-1.192.168.0.88   <none>           <none>\nkube-system   kube-proxy-f5qvr                          1/1     Running   0          19d     172.16.0.32    us-west-1.192.168.0.88   <none>           <none>\n\n// then delete all pods above except yurthub pod.\n$ kubectl -n kube-system delete pod coredns-qq6dk kube-flannel-ds-j698r kube-proxy-f5qvr\n")))}p.isMDXComponent=!0}}]);