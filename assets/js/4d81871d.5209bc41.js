"use strict";(self.webpackChunkopenyurt_io=self.webpackChunkopenyurt_io||[]).push([[3498],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return m}});var o=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},r=Object.keys(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var u=o.createContext({}),s=function(e){var t=o.useContext(u),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=s(e.components);return o.createElement(u.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},d=o.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,u=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),d=s(n),m=a,h=d["".concat(u,".").concat(m)]||d[m]||c[m]||r;return n?o.createElement(h,i(i({ref:t},p),{},{components:n})):o.createElement(h,i({ref:t},p))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,i=new Array(r);i[0]=d;var l={};for(var u in t)hasOwnProperty.call(t,u)&&(l[u]=t[u]);l.originalType=e,l.mdxType="string"==typeof e?e:a,i[1]=l;for(var s=2;s<r;s++)i[s]=n[s];return o.createElement.apply(null,i)}return o.createElement.apply(null,n)}d.displayName="MDXCreateElement"},227:function(e,t,n){n.r(t),n.d(t,{assets:function(){return u},contentTitle:function(){return i},default:function(){return c},frontMatter:function(){return r},metadata:function(){return l},toc:function(){return s}});var o=n(7462),a=(n(7294),n(3905));const r={title:"How to Build and Test"},i=void 0,l={unversionedId:"developer-manuals/how-to-build-and-test",id:"developer-manuals/how-to-build-and-test",title:"How to Build and Test",description:"In OpenYurt repository, currently(v0.7.0, commit",source:"@site/docs/developer-manuals/how-to-build-and-test.md",sourceDirName:"developer-manuals",slug:"/developer-manuals/how-to-build-and-test",permalink:"/docs/next/developer-manuals/how-to-build-and-test",draft:!1,editUrl:"https://github.com/openyurtio/openyurt.io/edit/master/docs/developer-manuals/how-to-build-and-test.md",tags:[],version:"current",lastUpdatedBy:"rambohe-ch",lastUpdatedAt:1654756955,formattedLastUpdatedAt:"Jun 9, 2022",frontMatter:{title:"How to Build and Test"},sidebar:"docs",previous:{title:"Cloud-Edge-Device DevOps Collaboration",permalink:"/docs/next/best-practices/practices-1"},next:{title:"Local Up OpenYurt",permalink:"/docs/next/developer-manuals/local-up-openyurt"}},u={},s=[{value:"How to build",id:"how-to-build",level:2},{value:"Build Binary",id:"build-binary",level:3},{value:"Build Image",id:"build-image",level:3},{value:"Cross Compilation",id:"cross-compilation",level:3},{value:"Mac",id:"mac",level:4},{value:"Windows",id:"windows",level:4},{value:"How to test",id:"how-to-test",level:2},{value:"Unit test",id:"unit-test",level:3},{value:"e2e test",id:"e2e-test",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2}],p={toc:s};function c(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,o.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"In ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/openyurtio/openyurt"},"OpenYurt repository"),", currently",(0,a.kt)("inlineCode",{parentName:"p"},"(v0.7.0, commit: 68a18ee)")," 7 components are contained, including:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"yurthub"),(0,a.kt)("li",{parentName:"ol"},"yurt-controller-manager"),(0,a.kt)("li",{parentName:"ol"},"yurt-tunnel-server"),(0,a.kt)("li",{parentName:"ol"},"yurt-tunnel-agent"),(0,a.kt)("li",{parentName:"ol"},"yurtctl"),(0,a.kt)("li",{parentName:"ol"},"yurtadm"),(0,a.kt)("li",{parentName:"ol"},"yurt-node-servant")),(0,a.kt)("p",null,"This article will give you an introduction of how to build and test the code after development of above components."),(0,a.kt)("h2",{id:"how-to-build"},"How to build"),(0,a.kt)("h3",{id:"build-binary"},"Build Binary"),(0,a.kt)("p",null,"OpenYurt ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/openyurtio/openyurt/blob/master/Makefile"},"Makefile")," provides a ",(0,a.kt)("inlineCode",{parentName:"p"},"make build")," command, can be completed by the command to the compilation of various components. The following uses yurtadm as an example to explain how to use 'make build', similar to other components."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"make build WHAT=cmd/yurtadm\n")),(0,a.kt)("p",null,"This command compiles yurtadm based on the OS and architecture of the local host and places the compiled executable binary in the _output directory."),(0,a.kt)("h3",{id:"build-image"},"Build Image"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"make docker-build")," is the most convenient image building command, including the steps of compiling and packaging images, can cover most scenarios. Its use is as follows:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'make docker-build TARGET_PLATFORMS="${TARGET_PLATFORMS}" REGION="${your_region}"\n')),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"TARGET_PLATFORMS"),": indicates the OS and architecture to which the component will run. Currently, Linux/amd64, Linux/arm, and Linux/arm64 are supported."),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"REGION"),": This parameter affects the GOPROXY used during compilation. Users in China are advised to set ",(0,a.kt)("inlineCode",{parentName:"p"},"REGION=cn")," to ensure proper construction (cn indicates ",(0,a.kt)("inlineCode",{parentName:"p"},"GOPROXY=https://goproxy.cn"),")."),(0,a.kt)("p",null,"Use cases:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"make docker-build TARGET_PLATFORMS=linux/amd64 REGION=cn\n")),(0,a.kt)("p",null,"After the command is executed, local images of each component of OpenYurt are generated, which can be viewed using ",(0,a.kt)("inlineCode",{parentName:"p"},"docker images"),"."),(0,a.kt)("h3",{id:"cross-compilation"},"Cross Compilation"),(0,a.kt)("h4",{id:"mac"},"Mac"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"GOOS=${target_os} GOARCH=${target_arch} CGO_ENABLED=0 make build WHAT=yurtadm\n")),(0,a.kt)("p",null,"This command will enable the built yurtadm binary to run on any platform as you want, through setting the ",(0,a.kt)("inlineCode",{parentName:"p"},"target_os")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"target_arch"),". To avoid some problems of compatibility, we'd better set ",(0,a.kt)("inlineCode",{parentName:"p"},"CGO_ENABLED=0"),"."),(0,a.kt)("h4",{id:"windows"},"Windows"),(0,a.kt)("p",null,"Because there's no make command on Windows(if you don't have Cygwin), we have to run ",(0,a.kt)("inlineCode",{parentName:"p"},"go build")," manually to compile the code. Steps in powershell(run as administrator) are as follows:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"prepare environment variables\nReplace ",(0,a.kt)("inlineCode",{parentName:"li"},"target_os")," and ",(0,a.kt)("inlineCode",{parentName:"li"},"target_arch")," as what you want.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},"$Env:GOOS = $Env:target_os\n$Env:GOARCH = $Env:target_arch\n$Env:CGO_ENABLED = 0\n$Env:GOLDFLAGS = \"-s -w \n-X github.com/openyurtio/openyurt/pkg/projectinfo.projectPrefix=yurt\n-X github.com/openyurtio/openyurt/pkg/projectinfo.labelPrefix=openyurt.io\n-X github.com/openyurtio/openyurt/pkg/projectinfo.gitVersion=$(git describe --abbrev=0)\n-X github.com/openyurtio/openyurt/pkg/projectinfo.gitCommit=$(git rev-parse HEAD)\n-X github.com/openyurtio/openyurt/pkg/projectinfo.buildDate=$(date -u +'%Y-%m-%dT%H:%M:%SZ')\"\n")),(0,a.kt)("ol",{start:2},(0,a.kt)("li",{parentName:"ol"},"run go build\nRun ",(0,a.kt)("inlineCode",{parentName:"li"},"go build")," to compile the code, with the ",(0,a.kt)("inlineCode",{parentName:"li"},"-ldflags=$Env:GOLDFLAGS")," option.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},"go build -ldflags=$Env:GOLDFLAGS cmd/yurtadm/yurtadm.go\n")),(0,a.kt)("h2",{id:"how-to-test"},"How to test"),(0,a.kt)("p",null,"There are tests of two types: unit test and e2e test."),(0,a.kt)("h3",{id:"unit-test"},"Unit test"),(0,a.kt)("p",null,"In unit test, it will run the test code under cmd and pkg folder, whose names have the suffix of ",(0,a.kt)("inlineCode",{parentName:"p"},"_test.go"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"make test\n")),(0,a.kt)("h3",{id:"e2e-test"},"e2e test"),(0,a.kt)("p",null,"This section shows how to build and run the e2e test for OpenYurt. The test for node autonomy is still under development."),(0,a.kt)("p",null,"If you have already set up the OpenYurt cluster, you can immediately follow the steps to test your cluster. Otherwise, you can quickly set up the OpenYurt at your local host with instructions at ",(0,a.kt)("a",{parentName:"p",href:"/docs/next/developer-manuals/local-up-openyurt"},"Local Up OpenYurt"),"."),(0,a.kt)("p",null,"You can use the following command to run e2e tests. Assuming that you've entered the openyurt work path, run"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"make e2e-tests\n")),(0,a.kt)("p",null,"This command will help you run e2e tests on OpenYurt cluster. It will use kubeconfig at ",(0,a.kt)("inlineCode",{parentName:"p"},"${KUBECONFIG}"),", default path is ",(0,a.kt)("inlineCode",{parentName:"p"},"$HOME/.kube/config"),". If there's no config found, it will end with error. The test result will show on the stdout:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"Ran 5 of 5 Specs in 82.279 seconds\nSUCCESS! -- 5 Passed | 0 Failed | 0 Pending | 0 Skipped\nPASS\n")),(0,a.kt)("p",null,"If you need further configuration for yurt-e2e-test to specify its behavior(such as running autonomy e2e test case), you can manually run the e2e test as we will introduce in the next section."),(0,a.kt)("h2",{id:"troubleshooting"},"Troubleshooting"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},'"go: github.com...unknown revision xxx" occurs during build',(0,a.kt)("br",{parentName:"p"}),"\n","It's often caused for too low git version on your host. You can try to update git.")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},'"unsupported GOOS/GOARCH pair xxx/xxx" occurs during compilation',(0,a.kt)("br",{parentName:"p"}),"\n","Not all GOOS/GOARCH pairs are supported by go, such as go1.17.3 cannot support windows/arm64. You can check all supported pairs through ",(0,a.kt)("inlineCode",{parentName:"p"},"go tool dist list"),".")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},'"cannot execute binary file: Exec format error" occurs when running binaries built on other platform.',(0,a.kt)("br",{parentName:"p"}),"\n","It's often caused by an unsuccessful cross compilation, and the OS cannot recoginze the file format. When you run cross compilation on Windows, please ensure that you run it as an administractor."))))}c.isMDXComponent=!0}}]);