"use strict";(self.webpackChunkopenyurt_io=self.webpackChunkopenyurt_io||[]).push([[1747],{3905:(e,t,n)=>{n.d(t,{Zo:()=>s,kt:()=>m});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var p=a.createContext({}),d=function(e){var t=a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},s=function(e){var t=d(e.components);return a.createElement(p.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,p=e.parentName,s=l(e,["components","mdxType","originalType","parentName"]),c=d(n),m=r,g=c["".concat(p,".").concat(m)]||c[m]||u[m]||i;return n?a.createElement(g,o(o({ref:t},s),{},{components:n})):a.createElement(g,o({ref:t},s))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=c;var l={};for(var p in t)hasOwnProperty.call(t,p)&&(l[p]=t[p]);l.originalType=e,l.mdxType="string"==typeof e?e:r,o[1]=l;for(var d=2;d<i;d++)o[d]=n[d];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},37897:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>o,default:()=>u,frontMatter:()=>i,metadata:()=>l,toc:()=>d});var a=n(87462),r=(n(67294),n(3905));const i={title:"YurtStaticSet"},o=void 0,l={unversionedId:"user-manuals/workload/yurt-static-set",id:"version-v1.3/user-manuals/workload/yurt-static-set",title:"YurtStaticSet",description:"Background",source:"@site/versioned_docs/version-v1.3/user-manuals/workload/yurt-static-set.md",sourceDirName:"user-manuals/workload",slug:"/user-manuals/workload/yurt-static-set",permalink:"/docs/user-manuals/workload/yurt-static-set",draft:!1,editUrl:"https://github.com/openyurtio/openyurt.io/edit/master/docs/user-manuals/workload/yurt-static-set.md",tags:[],version:"v1.3",lastUpdatedBy:"rambohe-ch",lastUpdatedAt:1686312326,formattedLastUpdatedAt:"Jun 9, 2023",frontMatter:{title:"YurtStaticSet"},sidebar:"docs",previous:{title:"YurtAppDaemon",permalink:"/docs/user-manuals/workload/yurt-app-daemon"},next:{title:"prometheus",permalink:"/docs/user-manuals/monitoring/prometheus"}},p={},d=[{value:"Background",id:"background",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Usage",id:"usage",level:2},{value:"1\uff09Deploy OpenYurt",id:"1deploy-openyurt",level:3},{value:"2\uff09Create static pod",id:"2create-static-pod",level:3},{value:"3) Deploy <code>YurtStaticSet</code> CR",id:"3-deploy-yurtstaticset-cr",level:3},{value:"4) Upgrade",id:"4-upgrade",level:3},{value:"AdvancedRollingUpdate Upgrade",id:"advancedrollingupdate-upgrade",level:4},{value:"OTA Upgrade",id:"ota-upgrade",level:4}],s={toc:d};function u(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},s,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"background"},"Background"),(0,r.kt)("p",null,"Static pod is a special type of pod in Kubernetes, which is managed directly by Kubelet.\nStatic pods are often used in cloud-edge collaboration scenarios, such as in some AI-related applications.\nIn OpenYurt, the core component, ",(0,r.kt)("inlineCode",{parentName:"p"},"YurtHub"),", is deployed using static pod.\nStatic pods are typically created through configuration files located in ",(0,r.kt)("inlineCode",{parentName:"p"},"/etc/kubernetes/manifests")," directory,\nand upgrades are performed by manually replacing or modifying these configuration files.\nDuring this process, Kubelet directly handles the creation and deletion of Static pods.\nHowever, due to the large quantity and dispersed nature of edge devices, deploying and upgrading Static pods manually\nin cloud-edge collaboration scenarios can lead to significant operational burdens and risks of mistakes.\nTherefore, OpenYurt has introduced a new Custom Resource Definition (CRD), ",(0,r.kt)("inlineCode",{parentName:"p"},"YurtStaticSet"),", to enhance the management of Static pods.\nIt provides capabilities such as rolling update and Over-The-Air (OTA) upgrade through a custom controller."),(0,r.kt)("h2",{id:"configuration"},"Configuration"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: apps.openyurt.io/v1alpha1\nkind: YurtStaticSet\nmetadata:\n  # \xb7\xb7\xb7\nspec:\n  # static pod configuration file name\n  staticPodManifest: xxx\n  # Upgrade strategy, supporting AdvancedRollingUpdate and OTA upgrade modes\n  upgradeStrategy:\n    type: AdvancedRollingUpdate\n    # For AdvancedRollingUpdate upgrade mode, set the maximum unavailable count during rolling update, default is 10%\n    # maxUnavailable: 3\n  # static pod template\n  template:\n  #  \xb7\xb7\xb7\n")),(0,r.kt)("h2",{id:"usage"},"Usage"),(0,r.kt)("h3",{id:"1deploy-openyurt"},"1\uff09Deploy OpenYurt"),(0,r.kt)("p",null,"The yurt-static-set controller is integrated within ",(0,r.kt)("inlineCode",{parentName:"p"},"Yurt-Manager")," component.\nBefore using, ",(0,r.kt)("inlineCode",{parentName:"p"},"OpenYurt")," needs to be installed and deployed.\nYou can refer to ",(0,r.kt)("a",{parentName:"p",href:"https://openyurt.io/docs/installation/manually-setup/#32-setup-openyurtopenyurt-components"},"Deploy OpenYurt")," for detailed operations."),(0,r.kt)("h3",{id:"2create-static-pod"},"2\uff09Create static pod"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"YurtStaticSet")," Operator does not manage the initialization of the static pod, which must be done manually or via ",(0,r.kt)("inlineCode",{parentName:"p"},"yurtadm")," tool.\nAs an example, this guide creates a cluster with three worker nodes using ",(0,r.kt)("inlineCode",{parentName:"p"},"Kind"),", and manually deploys a static pod on each node."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"cat >  nginx.yaml << EOF\napiVersion: v1\nkind: Pod\nmetadata:\n  name: nginx\nspec:\n  containers:\n  - name: web\n    image: nginx:1.19.1\nEOF\n")),(0,r.kt)("h3",{id:"3-deploy-yurtstaticset-cr"},"3) Deploy ",(0,r.kt)("inlineCode",{parentName:"h3"},"YurtStaticSet")," CR"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"YurtStaticSet")," resource corresponds to static pods via its ",(0,r.kt)("inlineCode",{parentName:"p"},"namespace/name"),".\nTherefore, we create a CR instance with ",(0,r.kt)("inlineCode",{parentName:"p"},"namespace:default, name:nginx")," to take over these static pods."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"cat <<EOF | kubectl apply -f -\napiVersion: apps.openyurt.io/v1alpha1\nkind: YurtStaticSet\nmetadata:\n  name: nginx\nspec:\n  staticPodManifest: nginx\n  upgradeStrategy:\n    type: AdvancedRollingUpdate\n    maxUnavailable: 3\n  template:\n    metadata:\n      name: nginx\n    spec:\n      containers:\n      - name: web\n        image: nginx:1.19.1\nEOF\n")),(0,r.kt)("h3",{id:"4-upgrade"},"4) Upgrade"),(0,r.kt)("p",null,"We can easily manage static pods with ",(0,r.kt)("inlineCode",{parentName:"p"},"YurtStaticSet")," resource, including upgrading static pods.\n",(0,r.kt)("inlineCode",{parentName:"p"},"YurtStaticSet")," supports two upgrade modes, ",(0,r.kt)("inlineCode",{parentName:"p"},"AdvancedRollingUpdate")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"OTA"),".\nSimply, ",(0,r.kt)("inlineCode",{parentName:"p"},"AdvancedRollingUpdate")," mode offers rolling update that skips ",(0,r.kt)("inlineCode",{parentName:"p"},"not-ready")," nodes;\n",(0,r.kt)("inlineCode",{parentName:"p"},"OTA")," mode allows users to control the upgrade process. Detailed introductions of the two modes can be found in ",(0,r.kt)("a",{parentName:"p",href:"https://openyurt.io/docs/user-manuals/workload/daemon-pod-updater/#background"},"DaemonSet Upgrade Model"),"."),(0,r.kt)("h4",{id:"advancedrollingupdate-upgrade"},"AdvancedRollingUpdate Upgrade"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Check the static pods in the cluster before upgrade")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"$ kubectl get pods | grep nginx\n\ndefault  nginx-openyurt-e2e-test-worker    1/1     Running   0   3h4m   10.244.2.3   openyurt-e2e-test-worker   \ndefault  nginx-openyurt-e2e-test-worker2   1/1     Running   0   3h4m   10.244.1.2   openyurt-e2e-test-worker2  \ndefault  nginx-openyurt-e2e-test-worker3   1/1     Running   0   3h5m   10.244.3.3   openyurt-e2e-test-worker3  \n\n$ kubectl describe pods nginx-openyurt-e2e-test-worker\n\n\xb7\xb7\xb7\nContainers:\n  web:\n    \xb7\xb7\xb7\n    # At this time, the version of nginx pod is 1.19.1\n    Image:          nginx:1.19.1\n    \xb7\xb7\xb7\n\xb7\xb7\xb7\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Modify ",(0,r.kt)("inlineCode",{parentName:"li"},"YurtStaticSet")," spec, upgrading the container image from nginx:1.19.1 to nginx:1.19.2")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: apps.openyurt.io/v1alpha1\nkind: YurtStaticSet\nmetadata:\n  name: nginx\nspec:\n    \xb7\xb7\xb7\n    spec:\n      containers:\n      - name: web\n        image: nginx:1.19.2\n\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Check the resource status, we can see that all three static pods have been upgraded.\n",(0,r.kt)("inlineCode",{parentName:"li"},"TOTAL")," represents how many static pods ",(0,r.kt)("inlineCode",{parentName:"li"},"YurtStaticSet nginx")," matches in this cluster.\n",(0,r.kt)("inlineCode",{parentName:"li"},"READY")," represents the number of ready pods, and ",(0,r.kt)("inlineCode",{parentName:"li"},"UPGRADED")," indicates how many pods have been upgraded to the latest version.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"$ kubectl get yurtstaticsets nginx\n\nNAME    AGE     TOTAL   READY   UPGRADED\nnginx   4m20s   3       3       3\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Check the corresponding static pods in the cluster")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"$ kubectl describe pods nginx-openyurt-e2e-test-worker\n\n\xb7\xb7\xb7\nContainers:\n  web:\n    \xb7\xb7\xb7\n    # At this point, the version of the nginx pod has been upgraded to 1.19.2\n    Image:          nginx:1.19.2\n    \xb7\xb7\xb7\n\xb7\xb7\xb7\n")),(0,r.kt)("h4",{id:"ota-upgrade"},"OTA Upgrade"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"OTA Upgrade API"),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"YurtHub")," provides two OTA upgrade-related REST APIs."),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"GET /pods"),"\nThis interface can be used to obtain information about the pods on the node."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"POST /openyurt.io/v1/namespaces/{ns}/pods/{podname}/upgrade"),"\nThis interface allows users to specify the upgrade of a particular static Pod. The path parameters ",(0,r.kt)("inlineCode",{parentName:"li"},"ns")," and ",(0,r.kt)("inlineCode",{parentName:"li"},"podname")," represent the namespace and name of the Pod respectively."))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"OTA Upgrade Process"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"In OTA upgrades, the upgrade status is represented by the ",(0,r.kt)("inlineCode",{parentName:"li"},"PodNeedUpgrade")," condition field in pod status. When the value is ",(0,r.kt)("inlineCode",{parentName:"li"},"true"),", it means there is upgradable version available. Otherwise, it cannot be upgraded. "),(0,r.kt)("li",{parentName:"ul"},"Static pod upgrades can be achieved by actively calling the upgrade API interface above.")))))}u.isMDXComponent=!0}}]);